<?xml version="1.0"?>
<project name="build.ant4eclipse"
         basedir=".."
         default="build.ant4eclipse"
         xmlns:ant4eclipse="antlib:org.ant4eclipse">

	<taskdef uri="antlib:org.ant4eclipse"
	         resource="org/ant4eclipse/antlib.xml" />

	<!-- define general properties -->
	<property name="build.compiler"
	          value="org.ant4eclipse.jdt.ecj.JDTCompilerAdapter" />
	<property name="destination"
	          value="${basedir}/org.ant4eclipse.build/destination" />
	<property name="teamprojectset"
	          value="${basedir}/org.ant4eclipse.build/projectSet-main.psf" />

	<!-- define your jdk location here -->
	<ant4eclipse:jreContainer>
		<jre id="jdk16" location="/usr/lib/jvm/java-6-sun" />
	</ant4eclipse:jreContainer>

	<!-- =================================
          target: build.ant4eclipse
         ================================= -->
	<target name="build.ant4eclipse">

		<delete dir="${destination}" quiet="true" />
		<mkdir dir="${destination}" />

		<tstamp>
			<format property="build.time" pattern="yyyyMMdd-HHmm" unit="hour" />
		</tstamp>

		<ant4eclipse:executeProjectSet workspace="${basedir}"
		                               teamprojectset="${teamprojectset}"
		                               projectReferenceTypes="jdt">

			<ant4eclipse:forEachProject>

				<ant4eclipse:executeJdtProject workspace="${basedir}"
				                               projectname="${executeProjectSet.project.name}">

					<ant4eclipse:forEachOutputDirectory>
						<echo>Scrubbing directory "${executeJdtProject.output.directory}"</echo>
						<delete dir="${executeJdtProject.output.directory}"
						        quiet="true" />
						<mkdir dir="${executeJdtProject.output.directory}" />
					</ant4eclipse:forEachOutputDirectory>


					<ant4eclipse:forAllSourceDirectories>
						<echo>Compiling jdt project '${executeJdtProject.project.name}'</echo>
						<echo>  - source directories -> ${executeJdtProject.source.directories}</echo>
						<echo>  - output directory   -> ${executeJdtProject.default.output.directory}</echo>
						<echo>  - bootclasspath      -> ${executeJdtProject.boot.classpath}</echo>
						<echo>  - classpath          -> ${executeJdtProject.classpath.absolute.compiletime}</echo>

						<javac destdir="${executeJdtProject.default.output.directory}"
						       debug="on"
						       source="1.5">

							<src refid="executeJdtProject.source.directories.path" />
							<bootclasspath refid="executeJdtProject.boot.classpath.path" />
							<classpath refid="executeJdtProject.classpath.absolute.compiletime.path" />

							<compilerarg value="compiler.args.refid=executeJdtProject.compiler.args"
							             compiler="org.ant4eclipse.jdt.ecj.JDTCompilerAdapter" />
						</javac>
					</ant4eclipse:forAllSourceDirectories>

					<ant4eclipse:forEachSourceDirectory>
						<echo>Copying resources from directory '${executeJdtProject.source.directory}'</echo>
						<copy todir="${executeJdtProject.output.directory}">
							<fileset dir="${executeJdtProject.source.directory}">
								<exclude name="**/*.java" />
							</fileset>
						</copy>
					</ant4eclipse:forEachSourceDirectory>

					<ant4eclipse:forEachOutputDirectory>
						<echo>Copying '${executeJdtProject.output.directory}'</echo>
						<copy toDir="${destination}/merged/classes">
							<fileset dir="${executeJdtProject.output.directory}">
								<include name="**/*.class" />
							</fileset>
						</copy>

						<copy toDir="${destination}/merged/cfg/${executeJdtProject.project.name}">
							<fileset dir="${executeJdtProject.output.directory}">
								<include name="**/antlib.xml" />
								<include name="**/ant4eclipse-configuration.properties" />
							</fileset>
						</copy>

						<copy toDir="${destination}/merged/classes">
							<fileset dir="${executeJdtProject.output.directory}">
								<include name="**/*.profile" />
								<include name="**/*.list" />
								<include name="**/*.xml" />
								<include name="**/*.properties" />
								<exclude name="**/antlib.xml" />
								<exclude name="**/ant4eclipse-configuration.properties" />
							</fileset>
						</copy>
					</ant4eclipse:forEachOutputDirectory>

				</ant4eclipse:executeJdtProject>

			</ant4eclipse:forEachProject>

		</ant4eclipse:executeProjectSet>

		<!-- merge all ant4eclipse.properties -->
		<ant4eclipse:mergeProperties destinationFile="${destination}/merged/classes/org/ant4eclipse/ant4eclipse-configuration.properties">
			<fileset dir="${destination}/merged/cfg">
				<include name="**/ant4eclipse-configuration.properties" />
				<exclude name="ant4eclipse-configuration.properties" />
			</fileset>
		</ant4eclipse:mergeProperties>

		<!-- merge all antlib.xml -->
		<ant4eclipse:mergeAntlibXml destinationFile="${destination}/merged/classes/org/ant4eclipse/antlib.xml">
			<fileset dir="${destination}/merged/cfg">
				<include name="**/antlib.xml" />
				<exclude name="antlib.xml" />
			</fileset>
		</ant4eclipse:mergeAntlibXml>

		<!-- build the jar file -->
		<jar destfile="${destination}/org.ant4eclipse_${revision}.jar"
		     basedir="${destination}/merged/classes" />

		<delete dir="${destination}/merged" quiet="true" />

		<mkdir dir="${destination}/libs"/>
		<copy toDir="${destination}/libs">
			<fileset dir="${basedir}/org.ant4eclipse.external/libs">
				<include name="ant-contrib/*.jar" />
				<include name="ejc/*.jar" />
				<include name="equinox/*.jar" />
			</fileset>
		</copy>

		<zip destfile="${destination}/org.ant4eclipse_${revision}.zip" >
		    <fileset dir="${destination}" excludes="${destination}/org.ant4eclipse_${revision}.zip"/>
		</zip>

	</target>

</project>